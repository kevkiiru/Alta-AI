<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ALTA AI FX</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460);
            color: #fff;
            overflow-x: hidden;
            min-height: 100vh;
        }

        .container {
            max-width: 100%;
            padding: 10px;
            padding-bottom: 80px;
        }

        .header {
            text-align: center;
            padding: 20px 10px;
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            margin-bottom: 15px;
            backdrop-filter: blur(10px);
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 5px;
            background: linear-gradient(45deg, #00d4ff, #0575e6, #00ff88);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            font-size: 12px;
            opacity: 0.6;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            margin-bottom: 15px;
            font-size: 13px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }

        .status-dot.connected {
            background: #00ff88;
            box-shadow: 0 0 10px #00ff88;
            animation: pulse 2s infinite;
        }

        .status-dot.disconnected {
            background: #ff0055;
        }

        .status-dot.connecting {
            background: #ffaa00;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .controls {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 15px;
        }

        .control-group {
            margin-bottom: 12px;
        }

        .control-group:last-child {
            margin-bottom: 0;
        }

        .control-group label {
            display: block;
            font-size: 12px;
            margin-bottom: 6px;
            opacity: 0.8;
            font-weight: 500;
        }

        .control-group select {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.1);
            color: #fff;
            font-size: 14px;
            cursor: pointer;
        }

        .control-group select option {
            background: #1a1a2e;
            color: #fff;
        }

        .chart-container {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
            gap: 8px;
        }

        .chart-title {
            font-weight: bold;
            font-size: 14px;
        }

        .timeframe-buttons {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .tf-btn {
            padding: 8px 14px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            color: #fff;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .tf-btn.active {
            background: linear-gradient(45deg, #00d4ff, #0575e6);
            border-color: #00d4ff;
        }

        .tf-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        #chartWrapper {
            width: 100%;
            height: 420px;
            background: #0a0e1a;
            border-radius: 10px;
            margin-bottom: 10px;
            position: relative;
            overflow: hidden;
        }

        #chart {
            width: 100%;
            height: 100%;
        }

        .chart-placeholder {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 5;
        }

        .chart-placeholder .spinner {
            margin: 0 auto 15px;
        }

        .price-info {
            display: flex;
            justify-content: space-between;
            padding: 12px;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            font-size: 12px;
        }

        .current-price {
            font-size: 26px;
            font-weight: bold;
            color: #00d4ff;
        }

        .price-change {
            font-size: 18px;
            font-weight: bold;
        }

        .price-change.positive {
            color: #00ff88;
        }

        .price-change.negative {
            color: #ff0055;
        }

        .signal-card {
            background: linear-gradient(135deg, rgba(0,212,255,0.1), rgba(5,117,230,0.05));
            border: 1px solid rgba(0,212,255,0.3);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .signal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .signal-title {
            font-size: 22px;
            font-weight: bold;
        }

        .signal-buy {
            color: #00ff88;
            text-shadow: 0 0 15px rgba(0,255,136,0.5);
        }

        .signal-sell {
            color: #ff0055;
            text-shadow: 0 0 15px rgba(255,0,85,0.5);
        }

        .signal-neutral {
            color: #ffaa00;
        }

        .entry-box {
            background: rgba(0,255,136,0.1);
            border: 2px solid #00ff88;
            border-radius: 12px;
            padding: 18px;
            margin: 15px 0;
            text-align: center;
        }

        .entry-box.sell-entry {
            background: rgba(255,0,85,0.1);
            border-color: #ff0055;
        }

        .entry-label {
            font-size: 12px;
            opacity: 0.8;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .entry-price {
            font-size: 26px;
            font-weight: bold;
            color: #00ff88;
        }

        .entry-price.sell {
            color: #ff0055;
        }

        .confidence-section {
            margin: 20px 0;
        }

        .confidence-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .confidence-label {
            font-size: 13px;
            font-weight: 500;
        }

        .confidence-percentage {
            font-size: 18px;
            font-weight: bold;
            color: #00d4ff;
        }

        .confidence-bar-container {
            height: 35px;
            background: rgba(255,255,255,0.1);
            border-radius: 18px;
            overflow: hidden;
            position: relative;
        }

        .confidence-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #00d4ff, #0575e6, #00ff88);
            border-radius: 18px;
            transition: width 0.5s ease;
            min-width: 0;
        }

        .confidence-bar-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-weight: bold;
            font-size: 14px;
            color: #fff;
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
        }

        .indicators-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 15px 0;
        }

        .indicator-box {
            background: rgba(255,255,255,0.05);
            padding: 12px;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .indicator-name {
            font-size: 11px;
            opacity: 0.7;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .indicator-value {
            font-size: 18px;
            font-weight: bold;
        }

        .indicator-bullish {
            color: #00ff88;
        }

        .indicator-bearish {
            color: #ff0055;
        }

        .indicator-neutral {
            color: #ffaa00;
        }

        .zones-section {
            margin: 15px 0;
        }

        .zones-title {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .zone-item {
            background: rgba(255,255,255,0.05);
            padding: 12px;
            margin: 8px 0;
            border-radius: 10px;
            border-left: 4px solid;
            font-size: 13px;
        }

        .demand-zone {
            border-left-color: #00ff88;
            background: rgba(0,255,136,0.05);
        }

        .supply-zone {
            border-left-color: #ff0055;
            background: rgba(255,0,85,0.05);
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(10,14,26,0.98);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-around;
            padding: 12px 0;
            z-index: 1000;
        }

        .nav-item {
            flex: 1;
            text-align: center;
            padding: 8px;
            cursor: pointer;
            transition: all 0.3s;
            border-radius: 10px;
            margin: 0 8px;
        }

        .nav-item.active {
            background: rgba(0,212,255,0.2);
        }

        .nav-icon {
            font-size: 24px;
            display: block;
            margin-bottom: 4px;
        }

        .nav-label {
            font-size: 11px;
            opacity: 0.8;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .signal-history-item {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            margin: 10px 0;
            border-radius: 12px;
            border-left: 4px solid;
        }

        .signal-history-item.buy {
            border-left-color: #00ff88;
        }

        .signal-history-item.sell {
            border-left-color: #ff0055;
        }

        .signal-history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .signal-history-type {
            font-size: 16px;
            font-weight: bold;
        }

        .signal-history-time {
            font-size: 11px;
            opacity: 0.6;
        }

        .signal-history-entry {
            font-size: 18px;
            font-weight: bold;
            margin: 8px 0;
        }

        .signal-history-meta {
            font-size: 12px;
            opacity: 0.7;
            margin-top: 8px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin: 15px 0;
        }

        .stat-card {
            background: rgba(255,255,255,0.05);
            padding: 18px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #00d4ff;
        }

        .stat-label {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 5px;
            text-transform: uppercase;
        }

        .alert-toast {
            position: fixed;
            top: -120px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(45deg, #00d4ff, #0575e6);
            padding: 16px 28px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            z-index: 2000;
            transition: top 0.4s ease;
            max-width: 90%;
            font-weight: 600;
            font-size: 15px;
            text-align: center;
        }

        .alert-toast.show {
            top: 25px;
        }

        .alert-toast.sell-alert {
            background: linear-gradient(45deg, #ff0055, #cc0044);
        }

        .alert-toast.buy-alert {
            background: linear-gradient(45deg, #00ff88, #00cc66);
        }

        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.98);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-screen.hidden {
            display: none;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,255,255,0.1);
            border-top: 4px solid #00d4ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .btn {
            padding: 12px 24px;
            border-radius: 10px;
            border: none;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 15px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #00d4ff, #0575e6);
            color: #fff;
        }

        .btn-secondary {
            background: rgba(255,255,255,0.1);
            color: #fff;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .btn:hover {
            transform: scale(1.02);
        }

        .empty-state {
            text-align: center;
            padding: 50px 20px;
            opacity: 0.5;
        }

        .empty-icon {
            font-size: 56px;
            margin-bottom: 15px;
        }

        .section-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .data-loading {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: rgba(0,212,255,0.1);
            border-radius: 8px;
            margin-bottom: 10px;
            font-size: 13px;
        }

        .mini-spinner {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.1);
            border-top: 2px solid #00d4ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="spinner"></div>
        <div style="font-size: 20px; margin-bottom: 10px; font-weight: 600;">ALTA AI FX</div>
        <div style="font-size: 13px; opacity: 0.7; margin-bottom: 5px;" id="loadingStatus">Initializing...</div>
        <div style="font-size: 11px; opacity: 0.5;" id="loadingDetail"></div>
        <button class="btn btn-secondary" onclick="skipLoading()" style="margin-top: 25px;">Enter Demo Mode</button>
    </div>

    <!-- Alert Toast -->
    <div class="alert-toast" id="alertToast"></div>

    <div class="container">
        <!-- Dashboard Page -->
        <div class="page active" id="dashboardPage">
            <div class="header">
                <h1>ALTA AI FX</h1>
                <p>Version 3.1</p>
            </div>

            <div class="status-bar">
                <div>
                    <span class="status-dot connecting" id="statusDot"></span>
                    <span id="statusText">Connecting...</span>
                </div>
                <div id="lastUpdate">--:--:--</div>
            </div>

            <div class="controls">
                <div class="control-group">
                    <label>üéØ Select Market</label>
                    <select id="marketSelect" onchange="changeMarket()">
                        <option value="1HZ25V">Volatility 25 (1s) üî•</option>
                        <option value="1HZ100V">Volatility 100 (1s)</option>
                        <option value="1HZ75V">Volatility 75 (1s)</option>
                        <option value="1HZ50V">Volatility 50 (1s)</option>
                        <option value="1HZ10V">Volatility 10 (1s)</option>
                        <option value="R_100">Volatility 100</option>
                        <option value="R_75">Volatility 75</option>
                        <option value="R_50">Volatility 50</option>
                        <option value="R_25">Volatility 25</option>
                        <option value="R_10">Volatility 10</option>
                        <option value="frxXAUUSD">Gold (XAU/USD) üí∞</option>
                    </select>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-header">
                    <div class="chart-title">üìà Live Chart</div>
                    <div class="timeframe-buttons">
                        <button class="tf-btn" data-tf="60" onclick="changeTF(60, this)">1M</button>
                        <button class="tf-btn" data-tf="300" onclick="changeTF(300, this)">5M</button>
                        <button class="tf-btn active" data-tf="900" onclick="changeTF(900, this)">15M</button>
                        <button class="tf-btn" data-tf="3600" onclick="changeTF(3600, this)">1H</button>
                        <button class="tf-btn" data-tf="14400" onclick="changeTF(14400, this)">4H</button>
                    </div>
                </div>
                <div id="chartWrapper">
                    <div id="chart"></div>
                    <div class="chart-placeholder" id="chartPlaceholder">
                        <div class="spinner"></div>
                        <div>Loading chart data...</div>
                    </div>
                </div>
                <div class="price-info">
                    <div>
                        <div style="font-size: 10px; opacity: 0.7;">Current Price</div>
                        <div class="current-price" id="currentPrice">Loading...</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 10px; opacity: 0.7;">Change</div>
                        <div class="price-change" id="priceChange">--%</div>
                    </div>
                </div>
            </div>

            <div class="signal-card">
                <div class="signal-header">
                    <div class="signal-title signal-neutral" id="signalTitle">‚è≥ ANALYZING</div>
                    <div style="font-size: 12px; opacity: 0.7;" id="signalTime">--:--:--</div>
                </div>

                <div id="entryDisplay"></div>

                <div class="confidence-section">
                    <div class="confidence-header">
                        <span class="confidence-label">Signal Strength</span>
                        <span class="confidence-percentage" id="confidencePercent">0%</span>
                    </div>
                    <div class="confidence-bar-container">
                        <div class="confidence-bar-fill" id="confidenceFill" style="width: 0%;"></div>
                        <div class="confidence-bar-text" id="confidenceText">0%</div>
                    </div>
                </div>

                <div class="indicators-grid">
                    <div class="indicator-box">
                        <div class="indicator-name">RSI (14)</div>
                        <div class="indicator-value indicator-neutral" id="rsiValue">--</div>
                    </div>
                    <div class="indicator-box">
                        <div class="indicator-name">Stoch RSI</div>
                        <div class="indicator-value indicator-neutral" id="stochValue">--</div>
                    </div>
                    <div class="indicator-box">
                        <div class="indicator-name">MACD</div>
                        <div class="indicator-value indicator-neutral" id="macdValue">--</div>
                    </div>
                    <div class="indicator-box">
                        <div class="indicator-name">Trend</div>
                        <div class="indicator-value indicator-neutral" id="trendValue">--</div>
                    </div>
                </div>

                <div class="zones-section">
                    <div class="zones-title">üìç Supply & Demand Zones</div>
                    <div id="zonesDisplay">
                        <div style="opacity: 0.5; padding: 15px; text-align: center;">Detecting zones...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Signals Page -->
        <div class="page" id="signalsPage">
            <div class="header">
                <h1>üìú Signal History</h1>
                <p>Saved for offline review</p>
            </div>

            <div class="signal-card">
                <div class="section-title">üìä Performance Stats</div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalSignalsCount">0</div>
                        <div class="stat-label">Total Signals</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" style="color: #00ff88;" id="buySignalsCount">0</div>
                        <div class="stat-label">Buy Signals</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" style="color: #ff0055;" id="sellSignalsCount">0</div>
                        <div class="stat-label">Sell Signals</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="avgConfidence">0%</div>
                        <div class="stat-label">Avg Strength</div>
                    </div>
                </div>
            </div>

            <div class="signal-card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div class="section-title" style="margin-bottom: 0;">Recent Signals</div>
                    <button class="btn btn-secondary" onclick="clearSignals()" style="padding: 8px 16px; font-size: 12px; margin: 0;">Clear All</button>
                </div>
                <div id="signalHistoryList">
                    <div class="empty-state">
                        <div class="empty-icon">üì≠</div>
                        <div>No signals yet</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <div class="nav-item active" onclick="switchPage('dashboard', this)">
            <div class="nav-icon">üìä</div>
            <div class="nav-label">Dashboard</div>
        </div>
        <div class="nav-item" onclick="switchPage('signals', this)">
            <div class="nav-icon">üìú</div>
            <div class="nav-label">Signals</div>
        </div>
    </div>

    <!-- Load Chart Library First -->
    <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
    
    <script>
        // ===================================
        // CONFIGURATION
        // ===================================
        const CONFIG = {
            APP_ID: 1089,
            WS_URL: 'wss://ws.derivws.com/websockets/v3?app_id=1089',
            DEFAULT_SYMBOL: '1HZ25V',
            DEFAULT_TF: 900,
            SIGNAL_THRESHOLD: 75,
            SIGNAL_COOLDOWN: 60000,
            TIMEFRAMES: {
                60: { label: '1M', count: 300 },
                300: { label: '5M', count: 300 },
                900: { label: '15M', count: 300 },
                3600: { label: '1H', count: 1000 },
                14400: { label: '4H', count: 1000 }
            }
        };

        // ===================================
        // STATE MANAGEMENT
        // ===================================
        let state = {
            ws: null,
            chart: null,
            candleSeries: null,
            currentSymbol: CONFIG.DEFAULT_SYMBOL,
            currentTF: CONFIG.DEFAULT_TF,
            isConnected: false,
            chartReady: false,
            priceData: {},
            signalHistory: [],
            lastSignalType: null,
            lastSignalTime: 0,
            lastEntryPrice: null,
            signalLocked: false,
            analysisInterval: null
        };

        // Initialize price data storage
        Object.keys(CONFIG.TIMEFRAMES).forEach(tf => {
            state.priceData[tf] = [];
        });

        // ===================================
        // UTILITY FUNCTIONS
        // ===================================
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            console.log(`[${timestamp}] [${type.toUpperCase()}] ${message}`);
        }

        function formatPrice(price) {
            if (price === null || price === undefined || isNaN(price)) return '--';
            
            if (price >= 1000) {
                return price.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            } else if (price >= 1) {
                return price.toFixed(2);
            } else {
                return price.toFixed(5);
            }
        }

        function updateLoadingStatus(status, detail = '') {
            const statusEl = document.getElementById('loadingStatus');
            const detailEl = document.getElementById('loadingDetail');
            if (statusEl) statusEl.textContent = status;
            if (detailEl) detailEl.textContent = detail;
        }

        // ===================================
        // ALERT SYSTEM
        // ===================================
        let alertTimer = null;

        function showAlert(message, type = 'info') {
            const toast = document.getElementById('alertToast');
            
            if (alertTimer) {
                clearTimeout(alertTimer);
                alertTimer = null;
            }
            
            toast.classList.remove('show', 'buy-alert', 'sell-alert');
            
            requestAnimationFrame(() => {
                toast.textContent = message;
                
                if (type === 'buy') toast.classList.add('buy-alert');
                else if (type === 'sell') toast.classList.add('sell-alert');
                
                toast.classList.add('show');
                
                alertTimer = setTimeout(() => {
                    toast.classList.remove('show');
                    alertTimer = null;
                }, 5000);
            });

            if ("Notification" in window && Notification.permission === "granted") {
                new Notification("ALTA AI FX", { body: message });
            }
        }

        // ===================================
        // CHART INITIALIZATION
        // ===================================
        function initChart() {
            log('Initializing chart...');
            
            const chartWrapper = document.getElementById('chartWrapper');
            const chartDiv = document.getElementById('chart');
            const placeholder = document.getElementById('chartPlaceholder');
            
            if (!chartDiv) {
                log('Chart container not found', 'error');
                return false;
            }

            // Check if library is loaded
            if (typeof LightweightCharts === 'undefined') {
                log('LightweightCharts library not loaded', 'error');
                placeholder.innerHTML = '<div style="color: #ff0055;">Chart library failed to load</div>';
                return false;
            }

            try {
                // Clear any existing chart
                chartDiv.innerHTML = '';
                
                state.chart = LightweightCharts.createChart(chartDiv, {
                    width: chartWrapper.clientWidth,
                    height: 420,
                    layout: {
                        background: { type: 'solid', color: '#0a0e1a' },
                        textColor: '#d1d4dc',
                    },
                    grid: {
                        vertLines: { color: 'rgba(255, 255, 255, 0.05)' },
                        horzLines: { color: 'rgba(255, 255, 255, 0.05)' },
                    },
                    crosshair: {
                        mode: LightweightCharts.CrosshairMode.Normal,
                    },
                    rightPriceScale: {
                        borderColor: 'rgba(255, 255, 255, 0.1)',
                        scaleMargins: { top: 0.1, bottom: 0.1 },
                    },
                    timeScale: {
                        borderColor: 'rgba(255, 255, 255, 0.1)',
                        timeVisible: true,
                        secondsVisible: false,
                    },
                });

                state.candleSeries = state.chart.addCandlestickSeries({
                    upColor: '#00ff88',
                    downColor: '#ff0055',
                    borderUpColor: '#00ff88',
                    borderDownColor: '#ff0055',
                    wickUpColor: '#00ff88',
                    wickDownColor: '#ff0055',
                });

                // Handle resize
                const resizeObserver = new ResizeObserver(entries => {
                    if (state.chart && entries[0]) {
                        state.chart.applyOptions({ 
                            width: entries[0].contentRect.width 
                        });
                    }
                });
                resizeObserver.observe(chartWrapper);

                state.chartReady = true;
                log('Chart initialized successfully');
                return true;

            } catch (error) {
                log(`Chart initialization error: ${error.message}`, 'error');
                placeholder.innerHTML = `<div style="color: #ff0055;">Chart error: ${error.message}</div>`;
                return false;
            }
        }

        function updateChart() {
            if (!state.chartReady || !state.candleSeries) return;
            
            const candles = state.priceData[state.currentTF];
            if (!candles || candles.length === 0) return;

            try {
                const chartData = candles.map(c => ({
                    time: c.time,
                    open: c.open,
                    high: c.high,
                    low: c.low,
                    close: c.close
                }));

                state.candleSeries.setData(chartData);
                
                // Hide placeholder
                const placeholder = document.getElementById('chartPlaceholder');
                if (placeholder) placeholder.style.display = 'none';
                
            } catch (error) {
                log(`Chart update error: ${error.message}`, 'error');
            }
        }

        // ===================================
        // TECHNICAL INDICATORS
        // ===================================
        function calculateRSI(closes, period = 14) {
            if (!closes || closes.length < period + 1) return 50;
            
            let gains = 0, losses = 0;
            for (let i = closes.length - period; i < closes.length; i++) {
                if (i < 1) continue;
                const change = closes[i] - closes[i - 1];
                if (change > 0) gains += change;
                else losses += Math.abs(change);
            }
            
            const avgGain = gains / period;
            const avgLoss = losses / period;
            if (avgLoss === 0) return 100;
            
            const rs = avgGain / avgLoss;
            return 100 - (100 / (1 + rs));
        }

        function calculateStochRSI(closes, period = 14) {
            if (!closes || closes.length < period * 2) return 50;
            
            const rsiValues = [];
            for (let i = period; i < closes.length; i++) {
                rsiValues.push(calculateRSI(closes.slice(0, i + 1), period));
            }
            
            if (rsiValues.length < period) return 50;
            
            const recentRSI = rsiValues.slice(-period);
            const minRSI = Math.min(...recentRSI);
            const maxRSI = Math.max(...recentRSI);
            const currentRSI = recentRSI[recentRSI.length - 1];
            
            if (maxRSI === minRSI) return 50;
            return ((currentRSI - minRSI) / (maxRSI - minRSI)) * 100;
        }

        function calculateEMA(data, period) {
            if (!data || data.length < period) return null;
            
            const multiplier = 2 / (period + 1);
            let ema = data.slice(0, period).reduce((a, b) => a + b, 0) / period;
            
            for (let i = period; i < data.length; i++) {
                ema = (data[i] - ema) * multiplier + ema;
            }
            return ema;
        }

        function calculateMACD(closes) {
            if (!closes || closes.length < 26) return 0;
            
            const ema12 = calculateEMA(closes, 12);
            const ema26 = calculateEMA(closes, 26);
            
            if (ema12 === null || ema26 === null) return 0;
            return ema12 - ema26;
        }

        function detectFractals(candles) {
            if (!candles || candles.length < 5) return { up: false, down: false };
            
            const lastFive = candles.slice(-5);
            const highs = lastFive.map(c => c.high);
            const lows = lastFive.map(c => c.low);
            
            const bullishFractal = lows[2] < lows[0] && lows[2] < lows[1] && 
                                   lows[2] < lows[3] && lows[2] < lows[4];
            
            const bearishFractal = highs[2] > highs[0] && highs[2] > highs[1] && 
                                   highs[2] > highs[3] && highs[2] > highs[4];
            
            return { up: bullishFractal, down: bearishFractal };
        }

        function detectSupplyDemandZones(candles) {
            if (!candles || candles.length < 30) return [];
            
            const zones = [];
            const lookback = Math.min(60, candles.length - 5);
            const recentCandles = candles.slice(-lookback);
            
            for (let i = 3; i < recentCandles.length - 3; i++) {
                const current = recentCandles[i];
                const next = recentCandles[i + 1];
                const nextNext = recentCandles[i + 2];
                
                if (!current || !next || !nextNext) continue;
                
                const bodySize = Math.abs(current.close - current.open);
                const range = current.high - current.low;
                if (range === 0) continue;
                
                const bodyRatio = bodySize / range;
                
                // Demand Zone
                if (current.close > current.open && 
                    bodyRatio > 0.6 && 
                    next.close > current.high &&
                    nextNext.close > next.close) {
                    
                    zones.push({
                        type: 'demand',
                        high: current.high,
                        low: current.low,
                        strength: Math.round(bodyRatio * 100)
                    });
                }
                
                // Supply Zone
                if (current.close < current.open && 
                    bodyRatio > 0.6 && 
                    next.close < current.low &&
                    nextNext.close < next.close) {
                    
                    zones.push({
                        type: 'supply',
                        high: current.high,
                        low: current.low,
                        strength: Math.round(bodyRatio * 100)
                    });
                }
            }
            
            return zones.sort((a, b) => b.strength - a.strength).slice(0, 3);
        }

        // ===================================
        // MARKET ANALYSIS
        // ===================================
        function analyzeMarket() {
            const candles = state.priceData[state.currentTF];
            
            if (!candles || candles.length < 50) {
                return {
                    signal: 'WAIT',
                    confidence: 0,
                    entryPrice: null,
                    currentPrice: null,
                    indicators: { rsi: 50, stochRSI: 50, macd: 0, trend: 'NEUTRAL' },
                    zones: []
                };
            }

            const closes = candles.map(c => c.close);
            const highs = candles.map(c => c.high);
            const lows = candles.map(c => c.low);
            const currentPrice = closes[closes.length - 1];

            // Calculate indicators
            const rsi = calculateRSI(closes, 14);
            const stochRSI = calculateStochRSI(closes, 14);
            const macd = calculateMACD(closes);
            const fractals = detectFractals(candles);
            const zones = detectSupplyDemandZones(candles);

            // EMA trend
            const ema20 = calculateEMA(closes, 20);
            const ema50 = calculateEMA(closes, 50);
            const trend = (ema20 && ema50) ? (ema20 > ema50 ? 'UP' : 'DOWN') : 'NEUTRAL';

            // Scoring
            let buyScore = 0;
            let sellScore = 0;

            // RSI (25 points)
            if (rsi < 30) buyScore += 25;
            else if (rsi < 40) buyScore += 15;
            else if (rsi > 70) sellScore += 25;
            else if (rsi > 60) sellScore += 15;

            // Stochastic RSI (20 points)
            if (stochRSI < 20) buyScore += 20;
            else if (stochRSI < 30) buyScore += 10;
            else if (stochRSI > 80) sellScore += 20;
            else if (stochRSI > 70) sellScore += 10;

            // MACD (20 points)
            if (macd > 0) buyScore += 20;
            else sellScore += 20;

            // Trend (15 points)
            if (trend === 'UP') buyScore += 15;
            else if (trend === 'DOWN') sellScore += 15;

            // Fractals (15 points)
            if (fractals.up) buyScore += 15;
            if (fractals.down) sellScore += 15;

            // Supply/Demand zones (20 points)
            for (const zone of zones) {
                const zoneMid = (zone.high + zone.low) / 2;
                const distance = Math.abs(currentPrice - zoneMid) / currentPrice * 100;
                
                if (distance < 0.5) {
                    if (zone.type === 'demand') buyScore += 20;
                    if (zone.type === 'supply') sellScore += 20;
                    break;
                }
            }

            // Calculate confidence
            const maxScore = 115;
            const buyConfidence = Math.min(Math.round((buyScore / maxScore) * 100), 100);
            const sellConfidence = Math.min(Math.round((sellScore / maxScore) * 100), 100);
            
            let signal = 'NEUTRAL';
            let confidence = Math.max(buyConfidence, sellConfidence);
            let entryPrice = null;

            if (buyConfidence >= CONFIG.SIGNAL_THRESHOLD && buyConfidence > sellConfidence) {
                signal = 'BUY';
                confidence = buyConfidence;
                const recentHigh = Math.max(...highs.slice(-20));
                entryPrice = recentHigh + (currentPrice * 0.0001);
            } else if (sellConfidence >= CONFIG.SIGNAL_THRESHOLD && sellConfidence > buyConfidence) {
                signal = 'SELL';
                confidence = sellConfidence;
                const recentLow = Math.min(...lows.slice(-20));
                entryPrice = recentLow - (currentPrice * 0.0001);
            }

            return {
                signal,
                confidence,
                entryPrice,
                currentPrice,
                indicators: {
                    rsi: rsi.toFixed(1),
                    stochRSI: stochRSI.toFixed(1),
                    macd: macd > 0 ? 'Bullish' : 'Bearish',
                    trend
                },
                zones
            };
        }

        // ===================================
        // UI UPDATE
        // ===================================
        function updateUI(analysis) {
            if (!analysis) return;
            
            const now = Date.now();

            // Update signal title
            const signalTitle = document.getElementById('signalTitle');
            signalTitle.className = 'signal-title';
            
            if (analysis.signal === 'BUY') {
                signalTitle.textContent = 'üöÄ BUY SIGNAL';
                signalTitle.classList.add('signal-buy');
            } else if (analysis.signal === 'SELL') {
                signalTitle.textContent = 'üìâ SELL SIGNAL';
                signalTitle.classList.add('signal-sell');
            } else {
                signalTitle.textContent = '‚è≥ ANALYZING';
                signalTitle.classList.add('signal-neutral');
            }

            // Update confidence
            const confidence = analysis.confidence || 0;
            document.getElementById('confidencePercent').textContent = confidence + '%';
            document.getElementById('confidenceFill').style.width = confidence + '%';
            document.getElementById('confidenceText').textContent = confidence + '%';

            // Update entry display
            const entryDisplay = document.getElementById('entryDisplay');
            
            if (analysis.entryPrice && (analysis.signal === 'BUY' || analysis.signal === 'SELL')) {
                const isBuy = analysis.signal === 'BUY';
                const formattedPrice = formatPrice(analysis.entryPrice);
                
                entryDisplay.innerHTML = `
                    <div class="entry-box ${isBuy ? '' : 'sell-entry'}">
                        <div class="entry-label">üí° Entry Signal</div>
                        <div class="entry-price ${isBuy ? '' : 'sell'}">
                            ${isBuy ? 'BUY ABOVE' : 'SELL BELOW'} ${formattedPrice}
                        </div>
                    </div>
                `;
                
                // Signal triggering with cooldown
                const priceChanged = Math.abs(analysis.entryPrice - (state.lastEntryPrice || 0)) > analysis.currentPrice * 0.001;
                const timePassed = (now - state.lastSignalTime) > CONFIG.SIGNAL_COOLDOWN;
                const typeChanged = analysis.signal !== state.lastSignalType;
                
                if ((typeChanged || priceChanged || timePassed) && !state.signalLocked) {
                    state.signalLocked = true;
                    
                    const alertMsg = `${analysis.signal} ${isBuy ? 'above' : 'below'} ${formattedPrice} (${analysis.confidence}%)`;
                    showAlert(alertMsg, isBuy ? 'buy' : 'sell');
                    saveSignal(analysis);
                    
                    state.lastSignalType = analysis.signal;
                    state.lastSignalTime = now;
                    state.lastEntryPrice = analysis.entryPrice;
                    
                    setTimeout(() => { state.signalLocked = false; }, CONFIG.SIGNAL_COOLDOWN);
                }
            } else {
                entryDisplay.innerHTML = '';
                if (analysis.signal === 'NEUTRAL') {
                    state.lastSignalType = null;
                    state.lastEntryPrice = null;
                }
            }

            // Update indicators
            const rsiValue = parseFloat(analysis.indicators.rsi);
            const rsiEl = document.getElementById('rsiValue');
            rsiEl.textContent = analysis.indicators.rsi;
            rsiEl.className = 'indicator-value ' + (rsiValue < 30 ? 'indicator-bullish' : rsiValue > 70 ? 'indicator-bearish' : 'indicator-neutral');

            const stochValue = parseFloat(analysis.indicators.stochRSI);
            const stochEl = document.getElementById('stochValue');
            stochEl.textContent = analysis.indicators.stochRSI;
            stochEl.className = 'indicator-value ' + (stochValue < 20 ? 'indicator-bullish' : stochValue > 80 ? 'indicator-bearish' : 'indicator-neutral');

            const macdEl = document.getElementById('macdValue');
            macdEl.textContent = analysis.indicators.macd;
            macdEl.className = 'indicator-value ' + (analysis.indicators.macd === 'Bullish' ? 'indicator-bullish' : 'indicator-bearish');

            const trendEl = document.getElementById('trendValue');
            trendEl.textContent = analysis.indicators.trend;
            trendEl.className = 'indicator-value ' + (analysis.indicators.trend === 'UP' ? 'indicator-bullish' : analysis.indicators.trend === 'DOWN' ? 'indicator-bearish' : 'indicator-neutral');

            // Update zones
            const zonesDisplay = document.getElementById('zonesDisplay');
            if (analysis.zones && analysis.zones.length > 0) {
                zonesDisplay.innerHTML = analysis.zones.map(zone => `
                    <div class="zone-item ${zone.type}-zone">
                        <strong>${zone.type === 'demand' ? 'üü¢ DEMAND' : 'üî¥ SUPPLY'} ZONE</strong>
                        <div style="margin-top: 6px; opacity: 0.9;">
                            ${formatPrice(zone.low)} - ${formatPrice(zone.high)}
                            <span style="opacity: 0.7; margin-left: 8px;">(${zone.strength}%)</span>
                        </div>
                    </div>
                `).join('');
            } else {
                zonesDisplay.innerHTML = '<div style="opacity: 0.5; padding: 15px; text-align: center;">No active zones</div>';
            }

            // Update time
            document.getElementById('signalTime').textContent = new Date().toLocaleTimeString();
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
        }

        function updatePriceDisplay() {
            const candles = state.priceData[state.currentTF];
            if (!candles || candles.length < 2) return;

            const current = candles[candles.length - 1];
            const first = candles[0];
            
            if (!current || !first) return;

            const change = ((current.close - first.close) / first.close) * 100;
            
            document.getElementById('currentPrice').textContent = formatPrice(current.close);
            
            const changeEl = document.getElementById('priceChange');
            changeEl.textContent = (change >= 0 ? '+' : '') + change.toFixed(2) + '%';
            changeEl.className = 'price-change ' + (change >= 0 ? 'positive' : 'negative');
        }

        // ===================================
        // SIGNAL PERSISTENCE
        // ===================================
        function saveSignal(analysis) {
            const signal = {
                id: Date.now(),
                timestamp: new Date().toISOString(),
                symbol: state.currentSymbol,
                symbolName: document.getElementById('marketSelect').selectedOptions[0]?.text || state.currentSymbol,
                timeframe: CONFIG.TIMEFRAMES[state.currentTF].label,
                type: analysis.signal,
                entryPrice: formatPrice(analysis.entryPrice),
                confidence: analysis.confidence,
                currentPrice: formatPrice(analysis.currentPrice)
            };

            state.signalHistory.unshift(signal);
            if (state.signalHistory.length > 100) {
                state.signalHistory = state.signalHistory.slice(0, 100);
            }
            
            localStorage.setItem('altaSignalHistory', JSON.stringify(state.signalHistory));
            updateSignalHistory();
        }

        function loadSignals() {
            try {
                const saved = localStorage.getItem('altaSignalHistory');
                if (saved) {
                    state.signalHistory = JSON.parse(saved);
                    updateSignalHistory();
                }
            } catch (e) {
                log('Error loading signals: ' + e.message, 'error');
                state.signalHistory = [];
            }
        }

        function updateSignalHistory() {
            const buyCount = state.signalHistory.filter(s => s.type === 'BUY').length;
            const sellCount = state.signalHistory.filter(s => s.type === 'SELL').length;
            const totalCount = state.signalHistory.length;
            
            let avgConf = 0;
            if (totalCount > 0) {
                avgConf = Math.round(state.signalHistory.reduce((sum, s) => sum + s.confidence, 0) / totalCount);
            }

            document.getElementById('totalSignalsCount').textContent = totalCount;
            document.getElementById('buySignalsCount').textContent = buyCount;
            document.getElementById('sellSignalsCount').textContent = sellCount;
            document.getElementById('avgConfidence').textContent = avgConf + '%';

            const historyList = document.getElementById('signalHistoryList');
            
            if (state.signalHistory.length === 0) {
                historyList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üì≠</div>
                        <div style="font-size: 16px; margin-bottom: 8px;">No signals yet</div>
                        <div style="font-size: 12px;">Signals are saved automatically</div>
                    </div>
                `;
            } else {
                historyList.innerHTML = state.signalHistory.map(s => {
                    const date = new Date(s.timestamp);
                    const isBuy = s.type === 'BUY';
                    
                    return `
                        <div class="signal-history-item ${isBuy ? 'buy' : 'sell'}">
                            <div class="signal-history-header">
                                <div class="signal-history-type" style="color: ${isBuy ? '#00ff88' : '#ff0055'}">
                                    ${isBuy ? 'üöÄ' : 'üìâ'} ${s.type}
                                </div>
                                <div class="signal-history-time">${date.toLocaleString()}</div>
                            </div>
                            <div class="signal-history-entry" style="color: ${isBuy ? '#00ff88' : '#ff0055'}">
                                ${isBuy ? 'Buy above' : 'Sell below'} ${s.entryPrice}
                            </div>
                            <div class="signal-history-meta">
                                ${s.symbolName} ‚Ä¢ ${s.timeframe} ‚Ä¢ ${s.confidence}% ‚Ä¢ Price: ${s.currentPrice}
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        function clearSignals() {
            if (confirm('Clear all signal history?')) {
                state.signalHistory = [];
                localStorage.removeItem('altaSignalHistory');
                updateSignalHistory();
                showAlert('History cleared');
            }
        }

        // ===================================
        // WEBSOCKET CONNECTION
        // ===================================
        function connect() {
            log('Connecting to Deriv API...');
            updateLoadingStatus('Connecting to Deriv...', 'Please wait');

            if (state.ws) {
                state.ws.close();
                state.ws = null;
            }

            try {
                state.ws = new WebSocket(CONFIG.WS_URL);

                const timeout = setTimeout(() => {
                    if (!state.isConnected) {
                        log('Connection timeout', 'error');
                        state.ws?.close();
                        handleConnectionError();
                    }
                }, 15000);

                state.ws.onopen = () => {
                    clearTimeout(timeout);
                    log('WebSocket connected');
                    updateLoadingStatus('Connected!', 'Loading market data...');
                    
                    state.isConnected = true;
                    document.getElementById('statusDot').className = 'status-dot connected';
                    document.getElementById('statusText').textContent = 'Live';

                    // Subscribe to ticks
                    state.ws.send(JSON.stringify({
                        ticks: state.currentSymbol,
                        subscribe: 1
                    }));

                    // Request candle data for all timeframes
                    Object.entries(CONFIG.TIMEFRAMES).forEach(([tf, config]) => {
                        log(`Requesting ${config.label} data...`);
                        state.ws.send(JSON.stringify({
                            ticks_history: state.currentSymbol,
                            count: config.count,
                            end: 'latest',
                            style: 'candles',
                            granularity: parseInt(tf),
                            req_id: parseInt(tf)
                        }));
                    });

                    // Hide loading after data loads
                    setTimeout(() => {
                        document.getElementById('loadingScreen').classList.add('hidden');
                        showAlert('‚úÖ Connected successfully!');
                    }, 3000);
                };

                state.ws.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        handleMessage(data);
                    } catch (e) {
                        log('Message parse error: ' + e.message, 'error');
                    }
                };

                state.ws.onerror = (error) => {
                    log('WebSocket error', 'error');
                    handleConnectionError();
                };

                state.ws.onclose = () => {
                    log('WebSocket closed');
                    state.isConnected = false;
                    document.getElementById('statusDot').className = 'status-dot disconnected';
                    document.getElementById('statusText').textContent = 'Disconnected';
                };

            } catch (error) {
                log('Connection error: ' + error.message, 'error');
                handleConnectionError();
            }
        }

        function handleMessage(data) {
            // Handle candle history
            if (data.candles) {
                const tf = data.req_id;
                log(`Received ${data.candles.length} candles for ${CONFIG.TIMEFRAMES[tf]?.label || tf}`);
                
                state.priceData[tf] = data.candles.map(c => ({
                    time: c.epoch,
                    open: parseFloat(c.open),
                    high: parseFloat(c.high),
                    low: parseFloat(c.low),
                    close: parseFloat(c.close)
                }));

                updateLoadingStatus('Connected!', `Loaded ${CONFIG.TIMEFRAMES[tf]?.label} data`);

                if (tf == state.currentTF) {
                    updateChart();
                    runAnalysis();
                }
            }

            // Handle live ticks
            if (data.tick) {
                handleTick(data.tick);
            }

            // Handle errors
            if (data.error) {
                log('API Error: ' + data.error.message, 'error');
            }
        }

        function handleTick(tick) {
            const tickTime = tick.epoch;
            const tickPrice = parseFloat(tick.quote);

            // Update all timeframes
            Object.keys(CONFIG.TIMEFRAMES).forEach(tf => {
                const timeframe = parseInt(tf);
                const candleTime = Math.floor(tickTime / timeframe) * timeframe;
                
                if (!state.priceData[timeframe]) {
                    state.priceData[timeframe] = [];
                }
                
                const candles = state.priceData[timeframe];
                
                if (candles.length === 0 || candles[candles.length - 1].time < candleTime) {
                    candles.push({
                        time: candleTime,
                        open: tickPrice,
                        high: tickPrice,
                        low: tickPrice,
                        close: tickPrice
                    });
                } else {
                    const last = candles[candles.length - 1];
                    last.high = Math.max(last.high, tickPrice);
                    last.low = Math.min(last.low, tickPrice);
                    last.close = tickPrice;
                }

                // Trim old candles
                const maxCount = CONFIG.TIMEFRAMES[tf].count;
                while (candles.length > maxCount) {
                    candles.shift();
                }
            });

            updateChart();
            updatePriceDisplay();
        }

        function handleConnectionError() {
            updateLoadingStatus('Connection failed', 'Entering demo mode...');
            setTimeout(skipLoading, 2000);
        }

        function runAnalysis() {
            const analysis = analyzeMarket();
            updateUI(analysis);
            updatePriceDisplay();
        }

        // ===================================
        // DEMO MODE
        // ===================================
        function skipLoading() {
            log('Entering demo mode');
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('statusDot').className = 'status-dot disconnected';
            document.getElementById('statusText').textContent = 'Demo Mode';
            showAlert('‚ö†Ô∏è Running in demo mode');
            
            generateDemoData();
            startDemoUpdates();
        }

        function generateDemoData() {
            const isGold = state.currentSymbol.includes('XAU');
            const isVolatility = state.currentSymbol.includes('1HZ') || state.currentSymbol.includes('R_');
            
            let basePrice;
            if (isGold) basePrice = 2050;
            else if (state.currentSymbol.includes('1HZ')) basePrice = 3.5;
            else basePrice = 5000;
            
            const now = Math.floor(Date.now() / 1000);
            
            Object.entries(CONFIG.TIMEFRAMES).forEach(([tf, config]) => {
                const timeframe = parseInt(tf);
                state.priceData[timeframe] = [];
                
                let price = basePrice;
                
                for (let i = config.count; i > 0; i--) {
                    const time = now - (i * timeframe);
                    const volatility = basePrice * 0.002;
                    const change = (Math.random() - 0.5) * volatility;
                    price += change;
                    
                    const open = price;
                    const close = open + (Math.random() - 0.5) * volatility;
                    const high = Math.max(open, close) + Math.random() * (volatility * 0.5);
                    const low = Math.min(open, close) - Math.random() * (volatility * 0.5);
                    
                    state.priceData[timeframe].push({ time, open, high, low, close });
                }
            });
            
            updateChart();
            runAnalysis();
            
            // Hide chart placeholder
            const placeholder = document.getElementById('chartPlaceholder');
            if (placeholder) placeholder.style.display = 'none';
        }

        function startDemoUpdates() {
            if (state.analysisInterval) {
                clearInterval(state.analysisInterval);
            }
            
            state.analysisInterval = setInterval(() => {
                const candles = state.priceData[60];
                if (candles && candles.length > 0) {
                    const lastPrice = candles[candles.length - 1].close;
                    const volatility = lastPrice * 0.0005;
                    const newPrice = lastPrice + (Math.random() - 0.5) * volatility;
                    
                    handleTick({
                        epoch: Math.floor(Date.now() / 1000),
                        quote: newPrice
                    });
                }
                
                runAnalysis();
            }, 1000);
        }

        // ===================================
        // UI CONTROLS
        // ===================================
        function switchPage(page, element) {
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            element.classList.add('active');
            
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(page + 'Page').classList.add('active');
            
            if (page === 'signals') {
                updateSignalHistory();
            }
        }

        function changeTF(tf, element) {
            state.currentTF = tf;
            
            document.querySelectorAll('.tf-btn').forEach(btn => btn.classList.remove('active'));
            element.classList.add('active');
            
            // Reset signal tracking
            state.lastSignalType = null;
            state.lastEntryPrice = null;
            state.signalLocked = false;
            
            updateChart();
            runAnalysis();
        }

        function changeMarket() {
            const select = document.getElementById('marketSelect');
            state.currentSymbol = select.value;
            
            log('Changing market to: ' + state.currentSymbol);
            
            // Clear data
            Object.keys(CONFIG.TIMEFRAMES).forEach(tf => {
                state.priceData[tf] = [];
            });
            
            // Reset signals
            state.lastSignalType = null;
            state.lastEntryPrice = null;
            state.lastSignalTime = 0;
            state.signalLocked = false;

            // Show chart placeholder
            const placeholder = document.getElementById('chartPlaceholder');
            if (placeholder) {
                placeholder.innerHTML = '<div class="spinner"></div><div>Loading ' + select.selectedOptions[0].text + '...</div>';
                placeholder.style.display = 'block';
            }

            if (state.isConnected && state.ws && state.ws.readyState === WebSocket.OPEN) {
                // Unsubscribe from old
                state.ws.send(JSON.stringify({ forget_all: 'ticks' }));
                
                // Subscribe to new
                state.ws.send(JSON.stringify({
                    ticks: state.currentSymbol,
                    subscribe: 1
                }));
                
                // Request new data
                Object.entries(CONFIG.TIMEFRAMES).forEach(([tf, config]) => {
                    state.ws.send(JSON.stringify({
                        ticks_history: state.currentSymbol,
                        count: config.count,
                        end: 'latest',
                        style: 'candles',
                        granularity: parseInt(tf),
                        req_id: parseInt(tf)
                    }));
                });
            } else {
                // Demo mode - regenerate data
                generateDemoData();
            }
        }

        // ===================================
        // INITIALIZATION
        // ===================================
        window.addEventListener('load', () => {
            log('ALTA AI FX v3.1 initializing...');
            
            // Request notifications
            if ("Notification" in window && Notification.permission === "default") {
                Notification.requestPermission();
            }
            
            // Load saved signals
            loadSignals();
            
            // Wait for chart library
            setTimeout(() => {
                updateLoadingStatus('Initializing chart...', '');
                
                if (initChart()) {
                    setTimeout(connect, 500);
                } else {
                    log('Chart init failed, entering demo mode');
                    setTimeout(skipLoading, 1000);
                }
            }, 500);
        });

        // Refresh on visibility change
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden && state.isConnected && state.ws?.readyState === WebSocket.OPEN) {
                log('Refreshing data...');
                Object.entries(CONFIG.TIMEFRAMES).forEach(([tf, config]) => {
                    state.ws.send(JSON.stringify({
                        ticks_history: state.currentSymbol,
                        count: config.count,
                        end: 'latest',
                        style: 'candles',
                        granularity: parseInt(tf),
                        req_id: parseInt(tf)
                    }));
                });
            }
        });
    </script>
</body>
</html>